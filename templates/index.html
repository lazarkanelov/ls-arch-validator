{% extends "base.html" %}
{% from "partials/probe_apps.html" import render_probe_apps %}

{% block title %}Dashboard - LocalStack Architecture Validator{% endblock %}

{% block content %}
<!-- Overview Section -->
<section id="overview" class="mb-8">
    <!-- Hero Stats Row -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Donut Chart Card (Allure-style) -->
        <div class="lg:col-span-1 bg-slate-800 rounded-xl p-6 border border-slate-700">
            <h3 class="text-sm font-medium text-slate-400 uppercase tracking-wider mb-4">Test Results</h3>
            <div class="flex items-center justify-center">
                <div class="relative">
                    <!-- SVG Donut Chart -->
                    <svg class="w-40 h-40" viewBox="0 0 36 36">
                        <!-- Background circle -->
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="#334155" stroke-width="3"></circle>
                        {% set total = statistics.total if statistics.total else 1 %}
                        {% set passed_pct = (statistics.passed / total * 100) if statistics else 0 %}
                        {% set partial_pct = (statistics.partial / total * 100) if statistics else 0 %}
                        {% set failed_pct = (statistics.failed / total * 100) if statistics else 0 %}
                        <!-- Passed segment (green) -->
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="#22c55e" stroke-width="3"
                                stroke-dasharray="{{ passed_pct }} {{ 100 - passed_pct }}"
                                stroke-dashoffset="25" class="donut-segment"></circle>
                        <!-- Partial segment (orange) -->
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="#f59e0b" stroke-width="3"
                                stroke-dasharray="{{ partial_pct }} {{ 100 - partial_pct }}"
                                stroke-dashoffset="{{ 25 - passed_pct }}" class="donut-segment"></circle>
                        <!-- Failed segment (red) -->
                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="#ef4444" stroke-width="3"
                                stroke-dasharray="{{ failed_pct }} {{ 100 - failed_pct }}"
                                stroke-dashoffset="{{ 25 - passed_pct - partial_pct }}" class="donut-segment"></circle>
                    </svg>
                    <!-- Center text -->
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-3xl font-bold text-white">{{ statistics.total if statistics else 0 }}</span>
                        <span class="text-xs text-slate-400">Total Tests</span>
                    </div>
                </div>
            </div>
            <!-- Legend -->
            <div class="flex justify-center gap-4 mt-4">
                <div class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded-full bg-success-500"></span>
                    <span class="text-sm text-slate-300">{{ statistics.passed if statistics else 0 }} Passed</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded-full bg-warning-500"></span>
                    <span class="text-sm text-slate-300">{{ statistics.partial if statistics else 0 }} Partial</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded-full bg-danger-500"></span>
                    <span class="text-sm text-slate-300">{{ statistics.failed if statistics else 0 }} Failed</span>
                </div>
            </div>
        </div>

        <!-- Pass Rate Card -->
        <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
            <h3 class="text-sm font-medium text-slate-400 uppercase tracking-wider mb-4">Pass Rate</h3>
            <div class="flex items-end justify-between">
                <div>
                    <span class="text-5xl font-bold text-white">{{ "%.0f"|format(statistics.pass_rate) if statistics else 0 }}</span>
                    <span class="text-2xl font-semibold text-slate-400">%</span>
                </div>
                {% if statistics and statistics.pass_rate_change is defined %}
                <div class="flex items-center gap-1 {% if statistics.pass_rate_change >= 0 %}text-success-400{% else %}text-danger-400{% endif %}">
                    {% if statistics.pass_rate_change >= 0 %}
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    {% else %}
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                    </svg>
                    {% endif %}
                    <span class="text-sm font-medium">{{ "%.1f"|format(statistics.pass_rate_change|abs) }}%</span>
                </div>
                {% endif %}
            </div>
            <!-- Progress bar -->
            <div class="mt-4">
                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-success-500 to-success-400 rounded-full transition-all duration-500"
                         style="width: {{ statistics.pass_rate if statistics else 0 }}%"></div>
                </div>
            </div>
            <!-- Source breakdown -->
            <div class="flex gap-4 mt-4">
                <div class="flex-1 bg-slate-700/50 rounded-lg p-3 text-center">
                    <div class="text-lg font-semibold text-white">{{ template_count }}</div>
                    <div class="text-xs text-slate-400">Templates</div>
                </div>
                <div class="flex-1 bg-slate-700/50 rounded-lg p-3 text-center">
                    <div class="text-lg font-semibold text-white">{{ diagram_count }}</div>
                    <div class="text-xs text-slate-400">Diagrams</div>
                </div>
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
            <h3 class="text-sm font-medium text-slate-400 uppercase tracking-wider mb-4">7-Day Trend</h3>
            <div class="h-40">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-success-500/10 rounded-lg">
                    <svg class="w-5 h-5 text-success-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <div class="text-2xl font-bold text-success-400">{{ statistics.passed if statistics else 0 }}</div>
                    <div class="text-xs text-slate-400">Passed</div>
                </div>
            </div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-warning-500/10 rounded-lg">
                    <svg class="w-5 h-5 text-warning-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div>
                    <div class="text-2xl font-bold text-warning-400">{{ statistics.partial if statistics else 0 }}</div>
                    <div class="text-xs text-slate-400">Partial</div>
                </div>
            </div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-danger-500/10 rounded-lg">
                    <svg class="w-5 h-5 text-danger-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <div class="text-2xl font-bold text-danger-400">{{ statistics.failed if statistics else 0 }}</div>
                    <div class="text-xs text-slate-400">Failed</div>
                </div>
            </div>
        </div>
        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-primary-500/10 rounded-lg">
                    <svg class="w-5 h-5 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </div>
                <div>
                    <div class="text-2xl font-bold text-primary-400">{{ service_coverage|length if service_coverage else 0 }}</div>
                    <div class="text-xs text-slate-400">Services</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Test Results Section -->
<section id="results" class="mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-white">Test Results</h2>
        <!-- Filter tabs -->
        <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
            <button class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md bg-primary-500 text-white" data-filter="all">All</button>
            <button class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md text-slate-400 hover:text-white" data-filter="failed">Failed</button>
            <button class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md text-slate-400 hover:text-white" data-filter="partial">Partial</button>
            <button class="filter-btn px-3 py-1.5 text-sm font-medium rounded-md text-slate-400 hover:text-white" data-filter="passed">Passed</button>
        </div>
    </div>

    <div class="space-y-3" id="results-list">
        <!-- Failed/Partial Results -->
        {% for failure in failures %}
        <div class="result-item bg-slate-800 rounded-xl border border-slate-700 overflow-hidden" data-status="{% if failure.infrastructure_error %}failed{% else %}partial{% endif %}">
            <button class="w-full flex items-center gap-4 p-4 text-left hover:bg-slate-750 transition-colors" onclick="toggleDetails(this)">
                <!-- Status indicator -->
                <div class="flex-shrink-0">
                    {% if failure.infrastructure_error %}
                    <span class="flex h-10 w-10 items-center justify-center rounded-full bg-danger-500/10 ring-1 ring-danger-500/20">
                        <svg class="h-5 w-5 text-danger-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </span>
                    {% else %}
                    <span class="flex h-10 w-10 items-center justify-center rounded-full bg-warning-500/10 ring-1 ring-warning-500/20">
                        <svg class="h-5 w-5 text-warning-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </span>
                    {% endif %}
                </div>

                <!-- Content -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <h3 class="text-sm font-medium text-white truncate">{{ failure.architecture_id }}</h3>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium {% if failure.source_type == 'diagram' %}bg-pink-500/10 text-pink-400{% else %}bg-blue-500/10 text-blue-400{% endif %}">
                            {{ failure.source_type }}
                        </span>
                    </div>
                    <p class="mt-1 text-sm text-slate-400 truncate">{{ failure.error_summary }}</p>
                </div>

                <!-- Services -->
                <div class="hidden sm:flex flex-wrap gap-1 max-w-xs">
                    {% for service in failure.services[:3] %}
                    <span class="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300">{{ service }}</span>
                    {% endfor %}
                    {% if failure.services|length > 3 %}
                    <span class="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-400">+{{ failure.services|length - 3 }}</span>
                    {% endif %}
                </div>

                <!-- Expand icon -->
                <svg class="w-5 h-5 text-slate-400 transform transition-transform expand-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>

            <!-- Expandable details -->
            <div class="details-panel hidden border-t border-slate-700">
                <div class="p-4 space-y-4">
                    <!-- Error details -->
                    {% if failure.infrastructure_error %}
                    <div class="bg-danger-500/5 border border-danger-500/20 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-danger-400 mb-2">Infrastructure Error</h4>
                        <pre class="text-sm text-slate-300 whitespace-pre-wrap font-mono">{{ failure.infrastructure_error }}</pre>
                    </div>
                    {% endif %}

                    {% if failure.test_failures %}
                    <div class="bg-warning-500/5 border border-warning-500/20 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-warning-400 mb-2">Failed Tests ({{ failure.test_failures|length }})</h4>
                        <ul class="space-y-1">
                            {% for test in failure.test_failures %}
                            <li class="flex items-center gap-2 text-sm text-slate-300">
                                <svg class="w-4 h-4 text-warning-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                {{ test }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Source info -->
                    {% if failure.source_info %}
                    <div class="bg-slate-700/30 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-slate-300 mb-3">Architecture Source</h4>
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <dt class="text-slate-400">Source:</dt>
                            <dd class="text-slate-200">{{ failure.source_info.source_name }}</dd>
                            {% if failure.source_info.original_format %}
                            <dt class="text-slate-400">Format:</dt>
                            <dd><span class="px-2 py-0.5 bg-slate-600 rounded text-xs text-slate-200">{{ failure.source_info.original_format }}</span></dd>
                            {% endif %}
                            {% if failure.source_info.source_url %}
                            <dt class="text-slate-400">URL:</dt>
                            <dd class="col-span-1">
                                <a href="{{ failure.source_info.source_url }}" target="_blank" rel="noopener" class="text-primary-400 hover:text-primary-300 break-all inline-flex items-center gap-1">
                                    {{ failure.source_info.source_url }}
                                    <svg class="w-3 h-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                            </dd>
                            {% endif %}
                            {% if failure.source_info.diagram_confidence is defined and failure.source_info.diagram_confidence is not none %}
                            <dt class="text-slate-400">Confidence:</dt>
                            <dd class="flex items-center gap-2">
                                <div class="flex-1 h-1.5 bg-slate-600 rounded-full overflow-hidden max-w-20">
                                    <div class="h-full bg-gradient-to-r from-warning-500 to-success-500 rounded-full" style="width: {{ failure.source_info.diagram_confidence * 100 }}%"></div>
                                </div>
                                <span class="text-slate-200">{{ "%.0f"|format(failure.source_info.diagram_confidence * 100) }}%</span>
                            </dd>
                            {% endif %}
                        </dl>
                    </div>
                    {% endif %}

                    <!-- Terraform Infrastructure Code -->
                    {% if failure.terraform_code %}
                    <div class="bg-slate-850 rounded-lg overflow-hidden border border-slate-700">
                        <div class="px-4 py-3 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                                </svg>
                                <span class="text-sm font-medium text-white">Terraform Infrastructure</span>
                            </div>
                            <span class="text-xs text-slate-400">Generated from {{ failure.source_info.original_format|default('template') }}</span>
                        </div>
                        <!-- main.tf -->
                        <div class="border-b border-slate-700">
                            <div class="px-4 py-2 bg-slate-800/50 text-xs text-slate-400 font-mono flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                main.tf
                            </div>
                            <pre class="language-hcl overflow-auto"><code>{{ failure.terraform_code.main_tf }}</code></pre>
                        </div>
                        {% if failure.terraform_code.variables_tf %}
                        <div class="border-b border-slate-700">
                            <div class="px-4 py-2 bg-slate-800/50 text-xs text-slate-400 font-mono flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                variables.tf
                            </div>
                            <pre class="language-hcl overflow-auto"><code>{{ failure.terraform_code.variables_tf }}</code></pre>
                        </div>
                        {% endif %}
                        {% if failure.terraform_code.outputs_tf %}
                        <div>
                            <div class="px-4 py-2 bg-slate-800/50 text-xs text-slate-400 font-mono flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                outputs.tf
                            </div>
                            <pre class="language-hcl overflow-auto"><code>{{ failure.terraform_code.outputs_tf }}</code></pre>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Generated Probe Applications -->
                    {% if failure.generated_apps %}
                    {{ render_probe_apps(failure.generated_apps) }}
                    {% elif failure.generated_app %}
                    {# Backwards compatibility: single app format #}
                    {{ render_probe_apps([failure.generated_app]) }}
                    {% endif %}

                    <!-- Test Execution Details -->
                    <div class="bg-slate-700/30 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            How This Test Was Conducted
                        </h4>
                        <div class="space-y-3 text-sm text-slate-300">
                            <div class="flex gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-primary-500/20 text-primary-400 flex items-center justify-center text-xs font-bold">1</span>
                                <div>
                                    <div class="font-medium text-white">Architecture Scraped</div>
                                    <div class="text-slate-400">The architecture was scraped from <a href="{{ failure.source_info.source_url if failure.source_info else '#' }}" target="_blank" class="text-primary-400 hover:underline">{{ failure.source_info.source_name if failure.source_info else 'source' }}</a> and converted to Terraform format.</div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-primary-500/20 text-primary-400 flex items-center justify-center text-xs font-bold">2</span>
                                <div>
                                    <div class="font-medium text-white">Python App Generated</div>
                                    <div class="text-slate-400">A Python application was generated that uses the AWS services defined in this architecture ({{ failure.services|join(', ') }}).</div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-primary-500/20 text-primary-400 flex items-center justify-center text-xs font-bold">3</span>
                                <div>
                                    <div class="font-medium text-white">LocalStack Deployment</div>
                                    <div class="text-slate-400">The Terraform infrastructure was deployed to LocalStack using <code class="px-1 bg-slate-800 rounded">terraform apply</code>.</div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-primary-500/20 text-primary-400 flex items-center justify-center text-xs font-bold">4</span>
                                <div>
                                    <div class="font-medium text-white">Tests Executed</div>
                                    <div class="text-slate-400">The generated Python tests were run against the LocalStack environment using <code class="px-1 bg-slate-800 rounded">pytest</code>.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Reproduction steps -->
                        <div class="mt-4 pt-4 border-t border-slate-600">
                            <h5 class="text-sm font-medium text-slate-300 mb-2">Reproduce This Test Locally</h5>
                            <pre class="bg-slate-800 rounded-lg p-3 text-xs text-slate-300 overflow-x-auto"><code># 1. Start LocalStack
docker run -d --name localstack -p 4566:4566 localstack/localstack

# 2. Clone and setup
git clone https://github.com/lazarkanelov/ls-arch-validator.git
cd ls-arch-validator

# 3. Run the specific architecture test
python -m ls_arch_validator test --architecture {{ failure.architecture_id }}

# 4. Or manually with Terraform
cd architectures/{{ failure.architecture_id }}
terraform init
terraform apply -auto-approve
pytest tests/</code></pre>
                        </div>
                    </div>

                    <!-- Action buttons -->
                    <div class="flex gap-2">
                        {% if failure.issue_url %}
                        <a href="{{ failure.issue_url }}" target="_blank" class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600 transition-colors">
                            <svg class="mr-1.5 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            View Issue
                        </a>
                        {% endif %}
                        {% if failure.logs_url %}
                        <a href="{{ failure.logs_url }}" target="_blank" class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600 transition-colors">
                            <svg class="mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            View Logs
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Passing Results -->
        {% for passing_item in passing %}
        <div class="result-item bg-slate-800 rounded-xl border border-slate-700 overflow-hidden" data-status="passed">
            <button class="w-full flex items-center gap-4 p-4 text-left hover:bg-slate-750 transition-colors" onclick="toggleDetails(this)">
                <div class="flex-shrink-0">
                    <span class="flex h-10 w-10 items-center justify-center rounded-full bg-success-500/10 ring-1 ring-success-500/20">
                        <svg class="h-5 w-5 text-success-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <h3 class="text-sm font-medium text-white truncate">{{ passing_item.architecture_id }}</h3>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium {% if passing_item.source_type == 'diagram' %}bg-pink-500/10 text-pink-400{% else %}bg-blue-500/10 text-blue-400{% endif %}">
                            {{ passing_item.source_type }}
                        </span>
                    </div>
                    <p class="mt-1 text-sm text-success-400">All tests passed</p>
                </div>
                <div class="hidden sm:flex flex-wrap gap-1 max-w-xs">
                    {% for service in passing_item.services[:3] %}
                    <span class="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300">{{ service }}</span>
                    {% endfor %}
                    {% if passing_item.services|length > 3 %}
                    <span class="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-400">+{{ passing_item.services|length - 3 }}</span>
                    {% endif %}
                </div>
                <svg class="w-5 h-5 text-slate-400 transform transition-transform expand-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>

            <div class="details-panel hidden border-t border-slate-700">
                <div class="p-4 space-y-4">
                    {% if passing_item.source_info %}
                    <div class="bg-slate-700/30 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-slate-300 mb-3">Architecture Source</h4>
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <dt class="text-slate-400">Source:</dt>
                            <dd class="text-slate-200">{{ passing_item.source_info.source_name }}</dd>
                            {% if passing_item.source_info.original_format %}
                            <dt class="text-slate-400">Format:</dt>
                            <dd><span class="px-2 py-0.5 bg-slate-600 rounded text-xs text-slate-200">{{ passing_item.source_info.original_format }}</span></dd>
                            {% endif %}
                            {% if passing_item.source_info.source_url %}
                            <dt class="text-slate-400">URL:</dt>
                            <dd class="col-span-1">
                                <a href="{{ passing_item.source_info.source_url }}" target="_blank" rel="noopener" class="text-primary-400 hover:text-primary-300 break-all inline-flex items-center gap-1">
                                    {{ passing_item.source_info.source_url }}
                                    <svg class="w-3 h-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                            </dd>
                            {% endif %}
                        </dl>
                    </div>
                    {% endif %}

                    <!-- Terraform Infrastructure Code -->
                    {% if passing_item.terraform_code %}
                    <div class="bg-slate-850 rounded-lg overflow-hidden border border-slate-700">
                        <div class="px-4 py-3 bg-slate-800 border-b border-slate-700 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                                </svg>
                                <span class="text-sm font-medium text-white">Terraform Infrastructure</span>
                            </div>
                            <span class="text-xs text-slate-400">Generated from {{ passing_item.source_info.original_format|default('template') if passing_item.source_info else 'template' }}</span>
                        </div>
                        <!-- main.tf -->
                        <div class="border-b border-slate-700">
                            <div class="px-4 py-2 bg-slate-800/50 text-xs text-slate-400 font-mono flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                main.tf
                            </div>
                            <pre class="language-hcl overflow-auto"><code>{{ passing_item.terraform_code.main_tf }}</code></pre>
                        </div>
                        {% if passing_item.terraform_code.variables_tf %}
                        <div class="border-b border-slate-700">
                            <div class="px-4 py-2 bg-slate-800/50 text-xs text-slate-400 font-mono flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                variables.tf
                            </div>
                            <pre class="language-hcl overflow-auto"><code>{{ passing_item.terraform_code.variables_tf }}</code></pre>
                        </div>
                        {% endif %}
                        {% if passing_item.terraform_code.outputs_tf %}
                        <div>
                            <div class="px-4 py-2 bg-slate-800/50 text-xs text-slate-400 font-mono flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                outputs.tf
                            </div>
                            <pre class="language-hcl overflow-auto"><code>{{ passing_item.terraform_code.outputs_tf }}</code></pre>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Generated Probe Applications -->
                    {% if passing_item.generated_apps %}
                    {{ render_probe_apps(passing_item.generated_apps) }}
                    {% elif passing_item.generated_app %}
                    {# Backwards compatibility: single app format #}
                    {{ render_probe_apps([passing_item.generated_app]) }}
                    {% endif %}

                    <!-- Test Execution Details -->
                    <div class="bg-slate-700/30 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            How This Test Was Conducted
                        </h4>
                        <div class="space-y-3 text-sm text-slate-300">
                            <div class="flex gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-success-500/20 text-success-400 flex items-center justify-center text-xs font-bold">1</span>
                                <div>
                                    <div class="font-medium text-white">Architecture Scraped</div>
                                    <div class="text-slate-400">The architecture was scraped from <a href="{{ passing_item.source_info.source_url if passing_item.source_info else '#' }}" target="_blank" class="text-primary-400 hover:underline">{{ passing_item.source_info.source_name if passing_item.source_info else 'source' }}</a> and converted to Terraform format.</div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-success-500/20 text-success-400 flex items-center justify-center text-xs font-bold">2</span>
                                <div>
                                    <div class="font-medium text-white">Python App Generated</div>
                                    <div class="text-slate-400">A Python application was generated that uses the AWS services defined in this architecture ({{ passing_item.services|join(', ') }}).</div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-success-500/20 text-success-400 flex items-center justify-center text-xs font-bold">3</span>
                                <div>
                                    <div class="font-medium text-white">LocalStack Deployment</div>
                                    <div class="text-slate-400">The Terraform infrastructure was deployed to LocalStack using <code class="px-1 bg-slate-800 rounded">terraform apply</code>.</div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <span class="flex-shrink-0 w-6 h-6 rounded-full bg-success-500/20 text-success-400 flex items-center justify-center text-xs font-bold">4</span>
                                <div>
                                    <div class="font-medium text-white">Tests Executed</div>
                                    <div class="text-slate-400">The generated Python tests were run against the LocalStack environment using <code class="px-1 bg-slate-800 rounded">pytest</code>. All tests passed!</div>
                                </div>
                            </div>
                        </div>

                        <!-- Reproduction steps -->
                        <div class="mt-4 pt-4 border-t border-slate-600">
                            <h5 class="text-sm font-medium text-slate-300 mb-2">Reproduce This Test Locally</h5>
                            <pre class="bg-slate-800 rounded-lg p-3 text-xs text-slate-300 overflow-x-auto"><code># 1. Start LocalStack
docker run -d --name localstack -p 4566:4566 localstack/localstack

# 2. Clone and setup
git clone https://github.com/lazarkanelov/ls-arch-validator.git
cd ls-arch-validator

# 3. Run the specific architecture test
python -m ls_arch_validator test --architecture {{ passing_item.architecture_id }}

# 4. Or manually with Terraform
cd architectures/{{ passing_item.architecture_id }}
terraform init
terraform apply -auto-approve
pytest tests/</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Service Coverage Section -->
<section id="services" class="mb-8">
    <h2 class="text-xl font-semibold text-white mb-4">Service Coverage</h2>
    <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-700">
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Service</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Coverage</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Passed</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Failed</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider">Pass Rate</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700">
                    {% for service in service_coverage %}
                    <tr class="hover:bg-slate-750 transition-colors">
                        <td class="px-4 py-3">
                            <span class="text-sm font-medium text-white">{{ service.name }}</span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden max-w-32">
                                    <div class="h-full bg-success-500 rounded-full" style="width: {{ service.pass_rate }}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-sm text-success-400">{{ service.passed }}</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="text-sm text-danger-400">{{ service.failed }}</span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <span class="text-sm font-medium text-white">{{ "%.0f"|format(service.pass_rate) }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if unsupported_services %}
    <div class="mt-4 bg-danger-500/5 border border-danger-500/20 rounded-xl p-4">
        <h3 class="text-sm font-medium text-danger-400 mb-2">Unsupported Services</h3>
        <div class="flex flex-wrap gap-2">
            {% for service in unsupported_services %}
            <span class="px-2 py-1 bg-danger-500/10 text-danger-300 rounded text-sm">{{ service }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</section>

<!-- Run History Section -->
<section id="history">
    <h2 class="text-xl font-semibold text-white mb-4">Run History</h2>
    <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-700">
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Run ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Date</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Total</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Passed</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-400 uppercase tracking-wider">Failed</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider">Pass Rate</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider">Duration</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700">
                    {% for run in run_history %}
                    <tr class="hover:bg-slate-750 transition-colors">
                        <td class="px-4 py-3">
                            <a href="{{ base_url }}/data/runs/{{ run.id }}.json" class="text-sm font-mono text-primary-400 hover:text-primary-300">{{ run.id[:12] }}...</a>
                        </td>
                        <td class="px-4 py-3 text-sm text-slate-300">{{ run.date }}</td>
                        <td class="px-4 py-3 text-center text-sm text-slate-300">{{ run.total }}</td>
                        <td class="px-4 py-3 text-center text-sm text-success-400">{{ run.passed }}</td>
                        <td class="px-4 py-3 text-center text-sm text-danger-400">{{ run.failed }}</td>
                        <td class="px-4 py-3 text-right">
                            <span class="text-sm font-medium text-white">{{ "%.0f"|format(run.pass_rate) }}%</span>
                        </td>
                        <td class="px-4 py-3 text-right text-sm text-slate-400">{{ run.duration_formatted }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Trend chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('trendChart');
    if (ctx) {
        const trendData = {{ trend_data | default({}) | tojson }};
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.labels || [],
                datasets: [{
                    label: 'Pass Rate',
                    data: trendData.pass_rates || [],
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        ticks: { color: '#94a3b8', font: { size: 10 } }
                    },
                    y: {
                        min: 0,
                        max: 100,
                        grid: { color: 'rgba(148, 163, 184, 0.1)' },
                        ticks: {
                            color: '#94a3b8',
                            font: { size: 10 },
                            callback: function(value) { return value + '%'; }
                        }
                    }
                }
            }
        });
    }

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('bg-primary-500', 'text-white');
                b.classList.add('text-slate-400');
            });
            this.classList.add('bg-primary-500', 'text-white');
            this.classList.remove('text-slate-400');

            const filter = this.dataset.filter;
            document.querySelectorAll('.result-item').forEach(item => {
                if (filter === 'all' || item.dataset.status === filter) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });

    // Highlight code
    Prism.highlightAll();
});

// Toggle details panel
function toggleDetails(button) {
    const panel = button.parentElement.querySelector('.details-panel');
    const icon = button.querySelector('.expand-icon');
    panel.classList.toggle('hidden');
    icon.classList.toggle('rotate-180');
    // Re-highlight code when shown
    if (!panel.classList.contains('hidden')) {
        Prism.highlightAllUnder(panel);
    }
}

// Code tabs
document.querySelectorAll('.code-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const container = this.closest('.bg-slate-850');
        container.querySelectorAll('.code-tab').forEach(t => {
            t.classList.remove('text-white', 'bg-slate-700/50', 'border-b-2', 'border-primary-500');
            t.classList.add('text-slate-400');
        });
        this.classList.add('text-white', 'bg-slate-700/50', 'border-b-2', 'border-primary-500');
        this.classList.remove('text-slate-400');

        container.querySelectorAll('.code-panel').forEach(p => p.classList.add('hidden'));
        document.getElementById(this.dataset.target).classList.remove('hidden');
    });
});
</script>
{% endblock %}
