name: Architecture Validation Pipeline

on:
  # Run on push to main branch
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'templates/**'
      - 'docs/**'
      - '.github/workflows/validate.yml'

  # Daily run at 3 AM UTC to discover and test NEW architectures
  schedule:
    - cron: '0 3 * * *'

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      skip_mining:
        description: 'Skip mining (use cached architectures)'
        type: boolean
        default: false
      skip_generation:
        description: 'Skip generation (use cached sample apps)'
        type: boolean
        default: false
      parallelism:
        description: 'Number of concurrent validations'
        type: number
        default: 1
      localstack_version:
        description: 'LocalStack image tag'
        type: string
        default: 'latest'
      specific_architectures:
        description: 'Specific architecture IDs (comma-separated, empty for all)'
        type: string
        default: ''
      create_issues:
        description: 'Create GitHub issues for failures'
        type: boolean
        default: true
      max_per_source:
        description: 'Maximum architectures per source'
        type: number
        default: 10
      incremental:
        description: 'Incremental mode: only test NEW architectures (default for scheduled runs)'
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'
  ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  validate:
    name: Run Validation Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Install tflocal and cf2tf
        run: |
          pip install terraform-local
          pip install cf2tf

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ./cache
          key: arch-validator-cache-v3-${{ github.run_id }}
          restore-keys: |
            arch-validator-cache-v3-

      - name: Start Docker service
        run: |
          sudo systemctl start docker
          docker info

      - name: Check environment
        run: |
          echo "Checking required environment variables..."
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "✅ ANTHROPIC_API_KEY is set (length: ${#ANTHROPIC_API_KEY})"
          else
            echo "⚠️ ANTHROPIC_API_KEY is NOT set - generation will be skipped"
            echo "To enable generation, add CLAUDE_API_KEY secret to repository settings"
          fi

      - name: Run validation pipeline
        id: validate
        run: |
          # Build command arguments
          # Use FSM processor for sequential, rate-limit-aware processing
          ARGS="--use-fsm"
          ARGS="$ARGS --parallelism ${{ inputs.parallelism || 1 }}"
          ARGS="$ARGS --localstack-version ${{ inputs.localstack_version || 'latest' }}"
          ARGS="$ARGS --max-per-source ${{ inputs.max_per_source || 10 }}"

          if [ "${{ inputs.skip_mining }}" = "true" ]; then
            ARGS="$ARGS --skip-mining"
          fi

          if [ "${{ inputs.skip_generation }}" = "true" ]; then
            ARGS="$ARGS --skip-generation"
          fi

          if [ "${{ inputs.create_issues }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            ARGS="$ARGS --create-issues"
            ARGS="$ARGS --github-repo ${{ github.repository }}"
            ARGS="$ARGS --dashboard-url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi

          # Use incremental mode for scheduled runs (daily discovery of NEW architectures)
          # For manual runs, use the input value
          if [ "${{ github.event_name }}" = "schedule" ]; then
            ARGS="$ARGS --incremental"
          elif [ "${{ inputs.incremental }}" = "true" ]; then
            ARGS="$ARGS --incremental"
          else
            # Force fresh for non-incremental manual runs
            ARGS="$ARGS --force-fresh"
          fi

          # Run the pipeline
          echo "=== Pipeline starting ==="
          echo "Current directory: $(pwd)"
          echo "Templates dir check:"
          ls -la templates/ 2>/dev/null || echo "templates/ not found in cwd"
          ls -la src/../templates/ 2>/dev/null || echo "src/../templates/ not found"

          ls-arch-validator run $ARGS | tee run_output.json

          echo "=== Pipeline completed ==="
          echo "Checking docs directory:"
          ls -la docs/ 2>/dev/null || echo "docs/ not found"
          echo "Checking docs/data/:"
          ls -la docs/data/ 2>/dev/null || echo "docs/data/ not found"
          echo "Checking docs/index.html:"
          if [ -f docs/index.html ]; then
            echo "docs/index.html exists, size: $(wc -c < docs/index.html) bytes"
            head -c 200 docs/index.html
          else
            echo "docs/index.html DOES NOT EXIST"
          fi

          # Extract status for workflow outcome
          STATUS=$(cat run_output.json | jq -r '.status')
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Save cache
        uses: actions/cache@v4
        with:
          path: |
            ./cache
          key: arch-validator-cache-v3-${{ github.run_id }}

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            docs/data/
            run_output.json
          retention-days: 30

      - name: Validate dashboard output
        id: validate_dashboard
        run: |
          echo "Validating dashboard output..."

          # Check if index.html exists
          if [ ! -f docs/index.html ]; then
            echo "::error::Dashboard index.html was not generated"
            echo "dashboard_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check file size (should be substantial HTML)
          SIZE=$(wc -c < docs/index.html)
          if [ "$SIZE" -lt 1000 ]; then
            echo "::error::Dashboard index.html is too small ($SIZE bytes) - likely failed to render"
            echo "dashboard_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check for error indicators in the HTML
          if grep -q "Dashboard Generation Failed\|Dashboard Error\|failed to generate" docs/index.html; then
            echo "::error::Dashboard contains error message - generation failed"
            echo "dashboard_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check for valid HTML structure
          if ! grep -q "<!DOCTYPE html>" docs/index.html; then
            echo "::error::Dashboard does not contain valid HTML doctype"
            echo "dashboard_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "✅ Dashboard validated successfully ($SIZE bytes)"
          echo "dashboard_valid=true" >> $GITHUB_OUTPUT
          ls -la docs/

      - name: Deploy to GitHub Pages
        if: success() || failure()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy validation dashboard - ${{ github.run_id }} ${{ github.sha }}'

      - name: Create summary
        if: always()
        run: |
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f run_output.json ]; then
            STATUS=$(cat run_output.json | jq -r '.status // "unknown"')
            RUN_ID=$(cat run_output.json | jq -r '.run_id // "N/A"')

            echo "**Status**: $STATUS" >> $GITHUB_STEP_SUMMARY
            echo "**Run ID**: $RUN_ID" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract statistics if available
            if cat run_output.json | jq -e '.statistics' > /dev/null 2>&1; then
              PASSED=$(cat run_output.json | jq -r '.statistics.passed // 0')
              FAILED=$(cat run_output.json | jq -r '.statistics.failed // 0')
              PARTIAL=$(cat run_output.json | jq -r '.statistics.partial // 0')
              PASS_RATE=$(cat run_output.json | jq -r '.statistics.pass_rate // 0')

              echo "### This Run Statistics" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
              echo "| Partial | $PARTIAL |" >> $GITHUB_STEP_SUMMARY
              echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
              echo "| Pass Rate | ${PASS_RATE}% |" >> $GITHUB_STEP_SUMMARY
            fi

            # Extract cumulative registry stats if available
            if cat run_output.json | jq -e '.registry' > /dev/null 2>&1; then
              TOTAL_ARCH=$(cat run_output.json | jq -r '.registry.total_architectures // 0')
              TESTED_ARCH=$(cat run_output.json | jq -r '.registry.tested_architectures // 0')
              NEW_THIS_WEEK=$(cat run_output.json | jq -r '.registry.new_this_week // 0')

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Cumulative Registry" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Total Architectures | $TOTAL_ARCH |" >> $GITHUB_STEP_SUMMARY
              echo "| Tested | $TESTED_ARCH |" >> $GITHUB_STEP_SUMMARY
              echo "| New This Week | $NEW_THIS_WEEK |" >> $GITHUB_STEP_SUMMARY
            fi

            # Extract timing if available
            if cat run_output.json | jq -e '.timing' > /dev/null 2>&1; then
              TOTAL=$(cat run_output.json | jq -r '.timing.total_seconds // 0')
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Total Duration**: ${TOTAL}s" >> $GITHUB_STEP_SUMMARY
            fi

            # Extract issues if available
            if cat run_output.json | jq -e '.issues' > /dev/null 2>&1; then
              CREATED=$(cat run_output.json | jq -r '.issues.created // 0')
              CLOSED=$(cat run_output.json | jq -r '.issues.closed // 0')
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Issues" >> $GITHUB_STEP_SUMMARY
              echo "- Created: $CREATED" >> $GITHUB_STEP_SUMMARY
              echo "- Closed: $CLOSED" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Status**: No output available" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Dashboard](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY

      - name: Check for guard failures
        if: always()
        run: |
          # Check if run_output.json contains guard failure
          if [ -f run_output.json ]; then
            PIPELINE_STATUS=$(cat run_output.json | jq -r '.pipeline_status // ""')
            EXIT_CODE=$(cat run_output.json | jq -r '.exit_code // 0')

            # Guard failure exit codes: 10-19
            if [[ "$EXIT_CODE" =~ ^1[0-9]$ ]]; then
              echo "::error::Guard check failed with exit code $EXIT_CODE"
              echo "Pipeline status: $PIPELINE_STATUS"

              case "$EXIT_CODE" in
                10) echo "Guard failure: ANTHROPIC_API_KEY not set" ;;
                11) echo "Guard failure: Templates directory not found" ;;
                12) echo "Guard failure: Docker not available" ;;
                13) echo "Guard failure: Output directory not writable" ;;
              esac

              # Output for summary
              echo "## Guard Failure" >> $GITHUB_STEP_SUMMARY
              echo "Exit code: $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
              echo "Status: $PIPELINE_STATUS" >> $GITHUB_STEP_SUMMARY
            fi

            # Stage failure exit codes: 20-29
            if [[ "$EXIT_CODE" =~ ^2[0-9]$ ]]; then
              echo "::error::Pipeline stage failed with exit code $EXIT_CODE"

              case "$EXIT_CODE" in
                20) echo "Stage failure: Mining failed" ;;
                21) echo "Stage failure: Generation failed" ;;
                22) echo "Stage failure: Validation failed" ;;
                23) echo "Stage failure: Reporting failed" ;;
              esac
            fi
          fi

      - name: Report validation results
        if: always()
        run: |
          STATUS="${{ steps.validate.outputs.status }}"
          if [ "$STATUS" = "error" ] || [ "$STATUS" = "partial" ]; then
            echo "::warning::Validation completed with issues (status: $STATUS). Check the dashboard for details."
          elif [ "$STATUS" = "success" ]; then
            echo "::notice::All validations passed successfully!"
          fi

  notify:
    name: Send Notifications
    needs: validate
    runs-on: ubuntu-latest
    if: always() && (needs.validate.result == 'failure' || needs.validate.result == 'success')

    steps:
      - name: Download results
        uses: actions/download-artifact@v4
        with:
          name: validation-results
          path: ./results

      - name: Send Slack notification (optional)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ needs.validate.result }}"
          COLOR="good"
          if [ "$STATUS" = "failure" ]; then
            COLOR="danger"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"LocalStack Architecture Validation\",
                \"text\": \"Pipeline completed with status: $STATUS\",
                \"fields\": [
                  {\"title\": \"Run\", \"value\": \"${{ github.run_id }}\", \"short\": true},
                  {\"title\": \"Trigger\", \"value\": \"${{ github.event_name }}\", \"short\": true}
                ],
                \"actions\": [{
                  \"type\": \"button\",
                  \"text\": \"View Dashboard\",
                  \"url\": \"https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\"
                }]
              }]
            }"
